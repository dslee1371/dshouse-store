<% const hero = (gallery && gallery.length ? gallery[0] : (product.image_path || '/placeholder.png')); %>

<% if (typeof user !== 'undefined' && user) { %>
  <div class="auth-banner">
    <span>ğŸ˜Š</span>
    <span><strong><%= user.name || user.email %></strong> ë‹˜ ë¡œê·¸ì¸ ì¤‘</span>
    <div class="right">
      <a class="btn small ghost" href="/account">ë§ˆì´í˜ì´ì§€</a>
      <form style="display:inline" method="POST" action="/logout">
        <button class="btn small ghost" type="submit">ë¡œê·¸ì•„ì›ƒ</button>
      </form>
    </div>
  </div>
<% } %>

<div class="product-grid">
  <div class="media">
    <div class="main-image can-zoom-in" id="img-wrap">
      <img id="main-img" src="<%= hero %>" alt="<%= product.title %>" />
    </div>

    <% if (gallery && gallery.length > 0) { %>
      <div class="thumbs">
        <% gallery.forEach(function(src, idx){ %>
          <img class="thumb <%= idx===0 ? 'active' : '' %>" src="<%= src %>" data-src="<%= src %>" alt="<%= product.title %> ì¸ë„¤ì¼ <%= idx+1 %>" />
        <% }) %>
      </div>
    <% } %>
  </div>

  <div>
    <h1 style="margin:0 0 10px"><%= product.title %></h1>
    <div class="price-block">
      <div class="price-lg"><%= product.price.toLocaleString() %>ì›</div>
      <span id="stockPill" class="stock-pill" aria-live="polite">ì¬ê³  í™•ì¸ ì¤‘â€¦</span>
    </div>
    <p style="font-size:14px;color:var(--muted);white-space:pre-wrap"><%= product.description || '' %></p>

    <% if (typeof user !== 'undefined' && user) { %>
      <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ: ì£¼ë¬¸ í¼ í‘œì‹œ -->
      <form class="form" method="POST" action="/checkout" style="margin-top:12px">
        <input type="hidden" name="product_id" value="<%= product.id %>" />
        <input type="hidden" name="variant_id" id="variantId" />

        <% if (variants && variants.length) { %>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <label>ì‚¬ì´ì¦ˆ
              <select id="selSize"></select>
            </label>
            <label>ìƒ‰ìƒ
              <select id="selColor"></select>
            </label>
          </div>
        <% } %>

        <label>ìˆ˜ëŸ‰
          <input id="qty" type="number" name="quantity" value="1" min="1" required />
        </label>

        <label>ì´ë¦„
          <input type="text" name="buyer_name" placeholder="êµ¬ë§¤ì ì„±í•¨"
                 value="<%= (user && user.name) || '' %>" autocomplete="name" />
          <small class="muted">íšŒì› ì •ë³´ë¡œ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ ê°€ëŠ¥</small>
        </label>

        <label>ì´ë©”ì¼
          <input type="email" name="buyer_email" placeholder="ì—°ë½ ë°›ì„ ì´ë©”ì¼"
                 value="<%= (user && user.email) || '' %>" readonly autocomplete="email" required />
          <small class="muted">ê°€ì… ì´ë©”ì¼ë¡œ ì£¼ë¬¸ ì•Œë¦¼ì„ ë³´ë‚´ë“œë ¤ìš”</small>
        </label>

        <button id="buyBtn" class="btn brand" type="submit">ì£¼ë¬¸í•˜ê¸°(ê³„ì¢Œì†¡ê¸ˆ)</button>
      </form>
    <% } else { %>
      <!-- ğŸš« ë¹„ë¡œê·¸ì¸: ì£¼ë¬¸ ë¶ˆê°€ ì•ˆë‚´ + ë¡œê·¸ì¸/íšŒì›ê°€ì… ìœ ë„ -->
      <div class="notice-card" style="margin-top:16px">
        <div class="title">ë¡œê·¸ì¸ í›„ ì£¼ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
        <div style="margin:6px 0 12px;color:var(--muted)">ì•„ë™ë³µìƒµì€ íšŒì› ë³´í˜¸ë¥¼ ìœ„í•´ ì£¼ë¬¸ì€ íšŒì›ë§Œ ê°€ëŠ¥í•´ìš”.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn brand" href="/login?next=/product/<%= product.id %>">ë¡œê·¸ì¸</a>
          <a class="btn ghost" href="/signup?next=/product/<%= product.id %>">íšŒì›ê°€ì…</a>
        </div>
      </div>
    <% } %>

    <div class="notice-card">
      <div class="title">ê³„ì¢Œì†¡ê¸ˆ ì•ˆë‚´</div>
      <div>
        ê³„ì¢Œë²ˆí˜¸: <span class="bank">ë†í˜‘ 241097-56-078780 ì¥ì€ì• </span>
        <button class="btn ghost" id="copyBtn" type="button">ë³µì‚¬</button>
      </div>
      <div style="margin-top:6px;color:var(--muted)">ì…ê¸ˆ í™•ì¸ í›„ ë°œì†¡ ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤. í‰ê·  1ì£¼ ì†Œìš”.</div>
    </div>
  </div>
</div>

<script>
  (function(){
    const container = document.getElementById('img-wrap');
    const main = document.getElementById('main-img');
    const thumbs = document.querySelectorAll('.thumb');

    // ì¸ë„¤ì¼ í´ë¦­: ì´ë¯¸ì§€ êµì²´ + ì¤Œ ì´ˆê¸°í™”
    thumbs.forEach(t => t.addEventListener('click', () => {
      const src = t.dataset.src || t.src;
      main.src = src;
      document.querySelectorAll('.thumb.active').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      resetZoom();
    }));

    // Zoom/Pan ìƒíƒœ
    let scale = 1, minScale = 1, maxScale = 4;
    let x = 0, y = 0;
    let dragging = false, startX = 0, startY = 0, originX = 0, originY = 0;
    let pinching = false, startDist = 0, startScale = 1;

    function apply(){
      main.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
      updateCursor();
    }
    function clampPan(){
      const rect = container.getBoundingClientRect();
      const maxX = Math.max(0, (rect.width * scale - rect.width) / 2);
      const maxY = Math.max(0, (rect.height * scale - rect.height) / 2);
      x = Math.min(maxX, Math.max(-maxX, x));
      y = Math.min(maxY, Math.max(-maxY, y));
    }
    function resetZoom(){
      scale = 1; x = 0; y = 0; apply();
    }
    function updateCursor(){
      container.classList.toggle('can-zoom-in', scale === 1);
      container.classList.toggle('can-zoom-out', scale > 1);
      container.classList.toggle('grabbable', scale > 1);
    }

    // ë”ë¸”í´ë¦­ ì¤Œ
    container.addEventListener('dblclick', () => {
      if (scale === 1) { scale = 2; } else { resetZoom(); return; }
      clampPan(); apply();
    });

    // íœ  ì¤Œ
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      const k = e.deltaY > 0 ? 0.9 : 1.1;
      scale = Math.min(maxScale, Math.max(minScale, scale * k));
      if (scale === 1) { x = 0; y = 0; }
      clampPan(); apply();
    }, { passive: false });

    // ë“œë˜ê·¸ íŒ¬
    container.addEventListener('mousedown', (e) => {
      if (scale === 1) return;
      dragging = true; container.classList.add('grabbing');
      startX = e.clientX; startY = e.clientY; originX = x; originY = y;
    });
    window.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      x = originX + (e.clientX - startX);
      y = originY + (e.clientY - startY);
      clampPan(); apply();
    });
    window.addEventListener('mouseup', () => { dragging = false; container.classList.remove('grabbing'); });

    // í„°ì¹˜: íŒ¬ + í•€ì¹˜
    container.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        if (scale === 1) return;
        dragging = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; originX = x; originY = y;
      } else if (e.touches.length === 2) {
        pinching = true; dragging = false;
        startDist = dist(e.touches[0], e.touches[1]);
        startScale = scale;
      }
    }, { passive: false });
    container.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (pinching && e.touches.length === 2) {
        const d = dist(e.touches[0], e.touches[1]);
        scale = Math.min(maxScale, Math.max(minScale, startScale * (d / startDist)));
        if (scale === 1) { x = 0; y = 0; }
        clampPan(); apply();
      } else if (dragging && e.touches.length === 1) {
        x = originX + (e.touches[0].clientX - startX);
        y = originY + (e.touches[0].clientY - startY);
        clampPan(); apply();
      }
    }, { passive: false });
    container.addEventListener('touchend', (e) => {
      if (e.touches.length === 0) { dragging = false; pinching = false; container.classList.remove('grabbing'); }
    }, { passive: false });
    function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

    // ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
    const copyBtn = document.getElementById('copyBtn');
    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText('ë†í˜‘ 241097-56-078780 ì¥ì€ì• ');
        copyBtn.textContent = 'ë³µì‚¬ë¨';
        setTimeout(()=> copyBtn.textContent='ë³µì‚¬', 1500);
      } catch(e){
        alert('ë³µì‚¬ ì‹¤íŒ¨');
      }
    });

    // âœ… ì˜µì…˜/ì¬ê³  ë¡œì§ (í¼ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ ê°€ë“œ í¬í•¨)
    const variants = <%- JSON.stringify(variants || []) %>;
    const selSize   = document.getElementById('selSize');
    const selColor  = document.getElementById('selColor');
    const variantId = document.getElementById('variantId');
    const qty       = document.getElementById('qty');
    const buyBtn    = document.getElementById('buyBtn');
    const pill      = document.getElementById('stockPill');

    function unique(arr){ return [...new Set(arr.filter(Boolean))]; }
    const sizes  = unique(variants.map(v=>v.size));
    const colors = unique(variants.map(v=>v.color));

    function fillSelect(sel, items){
      if (!sel) return;
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = ''; opt0.textContent = 'ì„ íƒí•˜ì„¸ìš”'; sel.appendChild(opt0);
      items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function currentVariant(){
      const s = selSize?.value || ''; const c = selColor?.value || '';
      return variants.find(v => (v.size||'')===s && (v.color||'')===c);
    }

    function updateStockView(){
      const setQtyMax = (v)=> { if (qty) qty.max = Math.max(1, v); };
      const setBuyDisabled = (flag)=> { if (buyBtn) buyBtn.disabled = !!flag; };

      if (!variants.length){
        const available = <%= (product.stock||0) %>;
        pill.className = 'stock-pill ' + (available>0?'good':'bad');
        pill.textContent = available>0 ? `ì¬ê³  ${available}ê°œ` : 'í’ˆì ˆ';
        setQtyMax(available);
        setBuyDisabled(available<=0);
        return;
      }
      const v = currentVariant();
      if (!v){
        pill.className = 'stock-pill';
        pill.textContent = 'ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”';
        setQtyMax(1);
        setBuyDisabled(true);
        if (variantId) variantId.value = '';
      } else {
        pill.className = 'stock-pill ' + (v.stock>0?'good':'bad');
        pill.textContent = v.stock>0 ? `ì¬ê³  ${v.stock}ê°œ` : 'í’ˆì ˆ';
        setQtyMax(v.stock||1);
        setBuyDisabled((v.stock||0) <= 0);
        if (variantId) variantId.value = v.id;
      }
    }

    if (variants.length){
      fillSelect(selSize, sizes);
      fillSelect(selColor, colors);
      selSize && selSize.addEventListener('change', updateStockView);
      selColor && selColor.addEventListener('change', updateStockView);
    }
    // ìë™ ì„ íƒ(ì˜µì…˜ í•˜ë‚˜ë¿ì´ë©´)
    if (variants.length){
      if (sizes.length === 1 && selSize) selSize.value = sizes[0];
      if (colors.length === 1 && selColor) selColor.value = colors[0];
      updateStockView();
    } else {
      updateStockView();
    }

    // í¼ ì œì¶œ UX (í¼ì´ ìˆì„ ë•Œë§Œ)
    const form = document.querySelector('form.form');
    form?.addEventListener('submit', (e) => {
      if (variants.length && !currentVariant()){
        e.preventDefault();
        pill.className = 'stock-pill';
        pill.textContent = 'ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”';
        selSize?.focus();
        return;
      }
      if (buyBtn){
        buyBtn.disabled = true;
        buyBtn.dataset.prev = buyBtn.textContent;
        buyBtn.textContent = 'ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘...';
      }
    });

    // ì´ˆê¸° ë Œë”
    apply();
  })();
</script>
